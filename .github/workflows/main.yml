name: Deploy Laravel to Hostinger

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # CHECKOUT
      # -------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------
      # SETUP PHP
      # -------------------------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, intl, bcmath, openssl, mysqli, pdo_mysql
          tools: composer

      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader

      # -------------------------
      # BUILD DEPLOY PACKAGE
      # -------------------------
      - name: Prepare Deployment Package
        run: |
          zip -r deploy.zip . \
            -x ".git/*" \
               ".github/*" \
               "storage/*" \
               ".env"

      # -------------------------
      # UPLOAD TO SERVER
      # -------------------------
      - name: Upload package to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy.zip"
          target: /home/${{ secrets.SSH_USER }}/tmp_deploy

      # =========================================================
      # ðŸš€ DEMO DEPLOYMENT
      # =========================================================
      - name: Deploy DEMO
        if: github.ref_name == 'demo'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            USER="${{ secrets.SSH_USER }}"

            mkdir -p "$DEPLOY_PATH"
            mv /home/$USER/tmp_deploy/deploy.zip "$DEPLOY_PATH"
            cd "$DEPLOY_PATH" || exit 1

            unzip -o deploy.zip && rm deploy.zip

            [ ! -f .env ] && cp .env.example-dev .env
            cp config/constants-dev.php config/constants.php

            chmod -R 775 storage bootstrap/cache

            ln -sfn \
              /home/$USER/domains/stepforenvironment.com/public_html/demo/storage/app/public \
              public/storage

            php artisan key:generate --force || true
            php artisan migrate --force
            php artisan optimize:clear
            php artisan optimize

      # =========================================================
      # ðŸš€ PRODUCTION DEPLOYMENT
      # =========================================================
      - name: Deploy PRODUCTION
        if: github.ref_name == 'main'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH_PRODUCTION }}"
            USER="${{ secrets.SSH_USER }}"

            mkdir -p "$DEPLOY_PATH"
            mv /home/$USER/tmp_deploy/deploy.zip "$DEPLOY_PATH"
            cd "$DEPLOY_PATH" || exit 1

            unzip -o deploy.zip && rm deploy.zip

            [ ! -f .env ] && cp .env.example .env
            cp config/constants-prod.php config/constants.php

            chmod -R 775 storage bootstrap/cache

            ln -sfn \
              /home/$USER/domains/stepforenvironment.com/public_html/storage/app/public \
              public/storage

            # php artisan key:generate --force
            php artisan config:clear
            php artisan route:clear
