name: Deploy Laravel to Hostinger

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # SET BRANCH & DEPLOY PATH
      # -------------------------
      - name: Set deploy path based on branch
        run: |
          BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

          if [ "$BRANCH" = "demo" ]; then
            echo "MAIN_PATH=$DEPLOY_PATH" >> $GITHUB_ENV
          elif [ "$BRANCH" = "main" ]; then
            echo "MAIN_PATH=$DEPLOY_PATH_PRODUCTION" >> $GITHUB_ENV
          else
            echo "MAIN_PATH=TEST" >> $GITHUB_ENV
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, intl, bcmath, openssl, mysqli, pdo_mysql
          tools: composer

      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader

      # -------------------------
      # BUILD DEPLOY PACKAGE
      # -------------------------
      - name: Prepare Deployment Package
        run: |
          zip -r deploy.zip . \
            -x ".git/*" \
               ".github/*" \
               "storage/*" \
               ".env"

      # -------------------------
      # UPLOAD TO HOSTINGER
      # -------------------------
      - name: Copy Files to Hostinger
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy.zip"
          target: ${{ env.MAIN_PATH }}

      # -------------------------
      # DEPLOY ON SERVER
      # -------------------------
      - name: Run Deployment Commands on Hostinger
        uses: appleboy/ssh-action@v1.0.3
        env:
          MAIN_PATH: ${{ env.MAIN_PATH }}
          BRANCH: ${{ env.BRANCH }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Branch: $BRANCH"
            echo "Deploy Path: $MAIN_PATH"

            cd "$MAIN_PATH" || exit 1

            unzip -o deploy.zip
            rm deploy.zip

            # ENV SAFE GUARD
            if [ ! -f .env ]; then
              cp .env.example-dev .env
            fi

            cp config/constants-dev.php config/constants.php

            chmod -R 775 storage bootstrap/cache

            # Storage symlink
            if [ "$BRANCH" = "demo" ]; then
              ln -sfn \
                /home/u781200572/domains/stepforenvironment.com/public_html/demo/storage/app/public \
                public/storage
            else
              ln -sfn \
                /home/u781200572/domains/stepforenvironment.com/public_html/storage/app/public \
                public/storage
            fi

            php artisan key:generate --force || true
            php artisan migrate --force

            php artisan optimize:clear
            php artisan optimize
